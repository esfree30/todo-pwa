<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toâ€‘Do List</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7bcfa3" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #eaf5ef;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #f7fbf9;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    h1 {
      text-align: center;
      font-size: 22px;
      margin: 0 0 10px 0;
    }

    .counter {
      text-align: center;
      font-size: 14px;
      color: #4f7f69;
      margin-bottom: 12px;
    }

    .date-strip {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 6px 2px 12px;
      margin-bottom: 10px;
    }

    .date-item {
      flex: 0 0 auto;
      min-width: 56px;
      padding: 8px 6px;
      border-radius: 14px;
      background: #ffffff;
      border: 1px solid #cfe6d8;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      color: #3f7f5f;
    }

    .date-item.active {
      background: #7bcfa3;
      color: #fff;
      border-color: #7bcfa3;
      font-weight: 600;
    }

    .date-item .day {
      font-size: 11px;
      opacity: 0.8;
    }

    .date-item .num {
      font-size: 16px;
      font-weight: 600;
    }
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    input[type="text"] {
      flex: 1;
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid #cfe6d8;
      font-size: 16px;
      background: #ffffff;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #7bcfa3;
    }

    button {
      padding: 12px 16px;
      border: none;
      border-radius: 999px;
      background: #7bcfa3;
      color: #ffffff;
      font-size: 15px;
      cursor: pointer;
    }

    button:active {
      transform: scale(0.97);
    }

    .clear-completed {
      width: 100%;
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #dff2e8;
      color: #3f7f5f;
      font-size: 14px;
      cursor: pointer;
    }

    .clear-completed:active {
      transform: scale(0.98);
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 12px;
      border-bottom: 1px solid #e3efe9;
      gap: 6px;
    }

    .task {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .task span {
      font-size: 16px;
      word-break: break-word;
    }

    .completed span {
      text-decoration: line-through;
      color: #aaa;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff5b5b;
      font-size: 18px;
      cursor: pointer;
      padding: 8px 10px;
    }

    .star-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #f2c94c; /* ë…¸ë‘ ë³„ */
      padding: 8px 10px;
    }

    .important span {
      font-weight: 600;
      color: #c89b00; /* ê°•ì¡° ë…¸ë‘ */
    }

    .edit-input {
      flex: 1;
      min-width: 0;
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cfe6d8;
      outline: none;
      background: #fff;
    }

    .hint {
      text-align: center;
      color: #6a8a7a;
      font-size: 12px;
      margin-top: 10px;
    }
  
    /* === ë‹¬ë ¥ íŒì—… === */
    .calendar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .calendar-modal {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      width: 90%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .calendar-modal h3 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .calendar-modal input[type="date"] {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #cfe6d8;
      font-size: 16px;
    }

    .calendar-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .calendar-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    .calendar-ok {
      background: #7bcfa3;
      color: white;
    }

    .calendar-cancel {
      background: #eee;
      color: #555;
    }

</head>
<body>
  <div class="calendar-overlay" id="calendarOverlay">
    <div class="calendar-modal">
      <h3>ë‚ ì§œ ì„ íƒ</h3>
      <input type="date" id="fullCalendarInput" />
      <div class="calendar-actions">
        <button class="calendar-cancel" id="calendarCancel">ì·¨ì†Œ</button>
        <button class="calendar-ok" id="calendarConfirm">ì„ íƒ</button>
      </div>
    </div>
  </div>

  <div class="app">
    <h1>ğŸ“ ì˜¤ëŠ˜ì˜ í•  ì¼</h1>
    <div class="counter" id="counter">ë‚¨ì€ í•  ì¼: 0ê°œ</div>

    <button id="openCalendarBtn" style="margin:6px auto 10px;display:block;background:#e3f4ec;border:none;border-radius:999px;padding:8px 14px;font-size:13px;color:#2f7d5b;cursor:pointer;">ğŸ“… ë‹¬ë ¥ ì „ì²´ ë³´ê¸°</button>

    <!-- ë‚ ì§œë³„ ê´€ë¦¬: ì„ íƒí•œ ë‚ ì§œì˜ í•­ëª©ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤ -->
    <div class="date-strip" id="dateStrip"></div>

    <div class="input-row">
      <input id="todoInput" type="text" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="addBtn" type="button">ì¶”ê°€</button>
    </div>

    <button class="clear-completed" id="clearCompletedBtn" type="button">ì™„ë£Œëœ í•­ëª© ëª¨ë‘ ì‚­ì œ</button>

    <ul id="todoList"></ul>

    <button id="installBtn" style="display:none;margin:12px auto 6px;display:block;padding:12px 18px;border-radius:999px;border:none;background:#7bcfa3;color:#fff;font-size:15px;cursor:pointer;">ğŸ“² ì•± ì„¤ì¹˜í•˜ê¸°</button>

    <div class="hint">íŒ: í•  ì¼ í…ìŠ¤íŠ¸ë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</div>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ëŠ” body ëì— ë‘ì–´ DOMì´ ë¨¼ì € ë¡œë“œë˜ë„ë¡ í•©ë‹ˆë‹¤ -->
  <script>
    // ===== PWA ì„¤ì¹˜ ë²„íŠ¼ ì²˜ë¦¬ =====
    let deferredPrompt = null;

    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });


    (function () {
      'use strict';

      // ====== ìƒìˆ˜/í‚¤ ======
      const STORAGE_KEY = 'todos_v1';

      // ====== DOM ì°¸ì¡° ======
      const input = document.getElementById('todoInput');
      const counter = document.getElementById('counter');
      const list = document.getElementById('todoList');
      const dateStrip = document.getElementById('dateStrip');
      const openCalendarBtn = document.getElementById('openCalendarBtn');
      const calendarOverlay = document.getElementById('calendarOverlay');
      const fullCalendarInput = document.getElementById('fullCalendarInput');
      const calendarCancel = document.getElementById('calendarCancel');
      const calendarConfirm = document.getElementById('calendarConfirm');
      const addBtn = document.getElementById('addBtn');
      const clearCompletedBtn = document.getElementById('clearCompletedBtn');

      // DOMì´ ì—†ìœ¼ë©´(êµ¬ì¡°ê°€ ë°”ë€Œì—ˆê±°ë‚˜ ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ê°€ ì˜ëª»ëœ ê²½ìš°) ë¹ ë¥´ê²Œ ì•Œë ¤ì¤Œ
      if (!input || !counter || !list || !datePicker || !addBtn || !clearCompletedBtn) {
        throw new Error('í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. HTMLì— #datePicker, #todoInput, #todoList ë“±ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
      }

      // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’
      const today = new Date();
      let selectedDate = formatDate(today);
      renderDateStrip();
      fullCalendarInput.value = selectedDate;

      // ====== ë°ì´í„° êµ¬ì¡° ======
      // todos = [{ id, text, completed, important, date }]
      let todos = [];

      // ====== ì €ì¥/ë¡œë“œ ======
      function saveTodos() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
      }

      function loadTodos() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        try {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            // ë°©ì–´ì ìœ¼ë¡œ í•„ë“œ ë³´ì •
            todos = parsed
              .filter(t => t && typeof t.text === 'string')
              .map(t => ({
                id: typeof t.id === 'string' ? t.id : cryptoRandomId(),
                text: t.text,
                completed: !!t.completed,
                important: !!t.important,
                date: typeof t.date === 'string' ? t.date : today
              }));
          }
        } catch {
          // ê¹¨ì§„ ì €ì¥ê°’ì´ë©´ ë¬´ì‹œ
          todos = [];
        }
      }

      // ====== ìœ í‹¸ ======
      function cryptoRandomId() {
        // crypto.randomUUIDê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ëŒ€ì²´
        if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
        return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now();
      }

      function getSelectedDate() {
        return selectedDate;
      }

      function getVisibleTodos() {
        const selected = getSelectedDate();
        return todos.filter(t => t.date === selected);
      }

      function updateCounter() {
        const remaining = getVisibleTodos().filter(t => !t.completed).length;
        counter.textContent = `ë‚¨ì€ í•  ì¼: ${remaining}ê°œ`;
      }

      function formatDate(d) {
        return d.toISOString().split('T')[0];
      }

      function renderDateStrip() {
        dateStrip.innerHTML = '';

        for (let i = -3; i <= 3; i++) {
          const d = new Date();
          d.setDate(d.getDate() + i);
          const value = formatDate(d);

          const item = document.createElement('div');
          item.className = 'date-item' + (value === selectedDate ? ' active' : '');

          const day = document.createElement('div');
          day.className = 'day';
          day.textContent = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];

          const num = document.createElement('div');
          num.className = 'num';
          num.textContent = d.getDate();

          item.appendChild(day);
          item.appendChild(num);

          item.addEventListener('click', () => {
            selectedDate = value;
            renderDateStrip();
            renderDateStrip();
      renderDateStrip();
      render();
          });

          dateStrip.appendChild(item);
        }
      }

      // ====== ë Œë” ======
      function render() {
        const visible = getVisibleTodos();

        // ëª©ë¡ ë¹„ìš°ê¸°
        list.innerHTML = '';

        // ë³´ì´ëŠ” í•­ëª© ë Œë”
        visible.forEach(t => {
          const li = document.createElement('li');
          li.dataset.id = t.id;
          if (t.completed) li.classList.add('completed');
          if (t.important) li.classList.add('important');

          const taskDiv = document.createElement('div');
          taskDiv.className = 'task';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = t.completed;

          const span = document.createElement('span');
          span.textContent = t.text;

          // âœï¸ ìˆ˜ì • (ë”ë¸”í´ë¦­)
          span.addEventListener('dblclick', () => {
            enterEditMode(li, taskDiv, span, t.id);
          });

          checkbox.addEventListener('change', () => {
            toggleCompleted(t.id, checkbox.checked);
          });

          taskDiv.appendChild(checkbox);
          taskDiv.appendChild(span);

          const starBtn = document.createElement('button');
          starBtn.className = 'star-btn';
          starBtn.type = 'button';
          starBtn.textContent = t.important ? 'â˜…' : 'â˜†';
          starBtn.onclick = () => toggleImportant(t.id);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.type = 'button';
          deleteBtn.textContent = 'âœ•';
          deleteBtn.onclick = () => deleteTodo(t.id);

          li.appendChild(taskDiv);
          li.appendChild(starBtn);
          li.appendChild(deleteBtn);

          list.appendChild(li);
        });

        updateCounter();
      }

      // ====== ë™ì‘ í•¨ìˆ˜ ======
      function addTodo() {
        const text = input.value.trim();
        if (!text) return;

        const selectedDate = getSelectedDate();
        const newTodo = {
          id: cryptoRandomId(),
          text,
          completed: false,
          important: false,
          date: selectedDate
        };

        todos.push(newTodo);
        input.value = '';
        saveTodos();
        render();
      }

      function deleteTodo(id) {
        todos = todos.filter(t => t.id !== id);
        saveTodos();
        render();
      }

      function toggleCompleted(id, checked) {
        const t = todos.find(x => x.id === id);
        if (!t) return;
        t.completed = !!checked;
        saveTodos();
        render();
      }

      function toggleImportant(id) {
        const t = todos.find(x => x.id === id);
        if (!t) return;
        t.important = !t.important;
        saveTodos();
        render();
      }

      function clearCompleted() {
        const selected = getSelectedDate();
        // ì„ íƒí•œ ë‚ ì§œì˜ ì™„ë£Œ í•­ëª©ë§Œ ì‚­ì œ (ê°€ì •)
        todos = todos.filter(t => !(t.date === selected && t.completed));
        saveTodos();
        render();
      }

      function enterEditMode(li, taskDiv, span, id) {
        // ì´ë¯¸ ìˆ˜ì • ëª¨ë“œë©´ ì¤‘ë³µ ì§„ì… ë°©ì§€
        const existing = taskDiv.querySelector('input.edit-input');
        if (existing) return;

        const edit = document.createElement('input');
        edit.className = 'edit-input';
        edit.type = 'text';
        edit.value = span.textContent;

        taskDiv.replaceChild(edit, span);
        edit.focus();
        edit.setSelectionRange(edit.value.length, edit.value.length);

        const commit = () => {
          const next = edit.value.trim();
          const t = todos.find(x => x.id === id);
          if (t && next) t.text = next;
          // ë¹ˆ ê°’ì´ë©´ ë³€ê²½í•˜ì§€ ì•ŠìŒ
          saveTodos();
          render();
        };

        const cancel = () => {
          render();
        };

        edit.addEventListener('blur', commit);
        edit.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            commit();
          }
          if (e.key === 'Escape') {
            e.preventDefault();
            cancel();
          }
        });
      }

      // ====== ë‚ ì§œ íŒì—… ì´ë²¤íŠ¸ ======
      openCalendarBtn.addEventListener('click', () => {
        fullCalendarInput.value = selectedDate;
        calendarOverlay.style.display = 'flex';
      });

      calendarCancel.addEventListener('click', () => {
        calendarOverlay.style.display = 'none';
      });

      calendarConfirm.addEventListener('click', () => {
        if (fullCalendarInput.value) {
          selectedDate = fullCalendarInput.value;
          renderDateStrip();
          render();
        }
        calendarOverlay.style.display = 'none';
      });

      // ====== ì´ë²¤íŠ¸ ë°”ì¸ë”© ======
      addBtn.addEventListener('click', addTodo);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addTodo();
      });
      clearCompletedBtn.addEventListener('click', clearCompleted);
      

      // ====== ê°„ë‹¨ í…ŒìŠ¤íŠ¸(ì½˜ì†”) ======
      // ê°œë°œ ì¤‘ ë¹ ë¥´ê²Œ í™•ì¸í•˜ê¸° ìœ„í•œ ìµœì†Œ ê²€ì¦
      function runSelfTests() {
        // datePicker ê°’ì´ ìˆì–´ì•¼ í•¨
        console.assert(!!getSelectedDate(), 'TEST: selected date should exist');
        // todosëŠ” ë°°ì—´ì´ì–´ì•¼ í•¨
        console.assert(Array.isArray(todos), 'TEST: todos should be an array');
      }

      // ====== ì´ˆê¸°í™” ======
      loadTodos();
      runSelfTests();
      render();
    })();
  </script>
  <script>
    // PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
