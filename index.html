<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤ëŠ˜ì˜ í•  ì¼</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7bcfa3" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #eaf5ef;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #f7fbf9;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    h1 { text-align:center; margin-bottom:8px; }

    .counter { text-align:center; font-size:14px; color:#4f7f69; margin-bottom:10px; }

    .date-strip { display:flex; gap:8px; overflow-x:auto; padding:6px 2px 12px; }

    .date-item {
      min-width:56px; padding:8px 6px; border-radius:14px;
      background:#fff; border:1px solid #cfe6d8;
      text-align:center; cursor:pointer; font-size:12px; color:#3f7f5f;
    }
    .date-item.active { background:#7bcfa3; color:#fff; border-color:#7bcfa3; }
    .date-item.today { border:2px solid #4caf8f; }
    .date-item .num { font-size:16px; font-weight:600; }

    .date-item .dot {
      width:6px;height:6px;border-radius:50%;margin:4px auto 0;background:#4caf8f;
    }
    .date-item .dot.done { background:#9fb7ad; }

    #openCalendarBtn { margin:6px auto 12px; display:block; padding:8px 14px; border:none; border-radius:999px; background:#e3f4ec; color:#2f7d5b; }

    .input-row { display:flex; gap:6px; margin-bottom:12px; }

    input[type=text], input[type=time] {
      padding:12px; border-radius:999px; border:1px solid #cfe6d8; font-size:14px;
    }

    input[type=text] { flex:1; }

    button { padding:12px 14px; border:none; border-radius:999px; background:#7bcfa3; color:white; cursor:pointer; }

    .clear-completed { width:100%; margin-bottom:12px; background:#dff2e8; color:#3f7f5f; }

    ul { list-style:none; padding:0; margin:0; }

    li { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #e3efe9; }

    .task { display:flex; align-items:center; gap:10px; flex:1; }

    .completed span { text-decoration:line-through; color:#aaa; }

    .star-btn { background:none; border:none; font-size:18px; color:#f2c94c; cursor:pointer; }
    .delete-btn { background:none; border:none; color:#ff5b5b; font-size:18px; cursor:pointer; }

    .hint { text-align:center; font-size:12px; color:#6a8a7a; margin-top:10px; }

    /* calendar */
    .calendar-overlay { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; justify-content:center; align-items:center; z-index:999; }
    .calendar-modal { background:#fff; border-radius:18px; padding:16px; width:95%; max-width:360px; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; text-align:center; }
    .calendar-cell { padding:8px 0; border-radius:10px; cursor:pointer; }
    .calendar-cell.today { border:2px solid #4caf8f; }
    .calendar-cell.selected { background:#7bcfa3; color:#fff; }
    .calendar-cell .dot { width:6px;height:6px;margin:4px auto 0;border-radius:50%;background:#4caf8f; }
    .calendar-cell .dot.done { background:#9fb7ad; }
  </style>
</head>
<body>

<div class="calendar-overlay" id="calendarOverlay">
  <div class="calendar-modal">
    <div class="calendar-header">
      <button id="prevMonth">â—€</button>
      <div id="calendarTitle"></div>
      <button id="nextMonth">â–¶</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<div class="app">
  <h1>ğŸ“ ì˜¤ëŠ˜ì˜ í•  ì¼</h1>
  <div class="counter" id="counter"></div>

  <div id="dateStrip" class="date-strip"></div>
  <button id="openCalendarBtn">ğŸ“… ë‹¬ë ¥ ì „ì²´ ë³´ê¸°</button>

  <div class="input-row">
    <input id="todoInput" type="text" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <input id="timeInput" type="time" />
    <button id="addBtn">ì¶”ê°€</button>
  </div>

  <button class="clear-completed" id="clearCompletedBtn">ì™„ë£Œëœ í•­ëª© ëª¨ë‘ ì‚­ì œ</button>

  <ul id="todoList"></ul>
  <div class="hint">â° ì‹œê°„ ì„¤ì • ì‹œ ì•Œë¦¼ì´ ìš¸ë¦½ë‹ˆë‹¤</div>
</div>

<script>
// âœ… ë‚ ì§œë¥¼ UTC(toISOString)ë¡œ ë°”ê¾¸ë©´ í•œêµ­ ì‹œê°„ì—ì„œ í•˜ë£¨ê°€ ë°€ë¦´ ìˆ˜ ìˆì–´ìš”.
//    ê·¸ë˜ì„œ ë¡œì»¬ ê¸°ì¤€(í˜„ì¬ ê¸°ê¸° ì‹œê°„ëŒ€)ìœ¼ë¡œ YYYY-MM-DDë¥¼ ë§Œë“¤ê³ /íŒŒì‹±í•©ë‹ˆë‹¤.
function pad2(n){ return String(n).padStart(2,'0'); }
function formatDateLocal(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function parseDateLocal(ymd){
  const [y,m,dd] = ymd.split('-').map(Number);
  return new Date(y, (m||1)-1, dd||1);
}

const STORAGE_KEY = 'todos_v2';
let todos = [];
let selectedDate = formatDateLocal(new Date());
let calendarMonth = new Date();

const dateStrip = document.getElementById('dateStrip');
const list = document.getElementById('todoList');
const counter = document.getElementById('counter');
const input = document.getElementById('todoInput');
const timeInput = document.getElementById('timeInput');

const calendarOverlay = document.getElementById('calendarOverlay');
const calendarGrid = document.getElementById('calendarGrid');
const calendarTitle = document.getElementById('calendarTitle');

/* ===== Notification permission ===== */
if ('Notification' in window && Notification.permission !== 'granted') {
  Notification.requestPermission();
}

function notify(title, body) {
  if (Notification.permission === 'granted') {
    new Notification(title, { body });
  }
}

function saveTodos() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
}

function loadTodos() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) try { todos = JSON.parse(saved); } catch {}
}

function formatDate(d){
  // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš© ë˜í¼(ë¡œì»¬ ê¸°ì¤€)
  return formatDateLocal(d);
}

/* ===== Date strip ===== */
function renderDateStrip() {
  dateStrip.innerHTML = '';
  for (let i = -3; i <= 3; i++) {
    const d = parseDateLocal(selectedDate);
    d.setDate(d.getDate() + i);
    const value = formatDate(d);

    const dayTodos = todos.filter(t => t.date === value);
    const hasTodos = dayTodos.length > 0;
    const allDone = hasTodos && dayTodos.every(t => t.completed);

    const item = document.createElement('div');
    item.className = 'date-item' + (value === selectedDate ? ' active' : '') + (value === formatDate(new Date()) ? ' today' : '');

    const day = document.createElement('div');
    day.textContent = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
    const num = document.createElement('div');
    num.className = 'num';
    num.textContent = d.getDate();

    item.append(day, num);

    if (hasTodos) {
      const dot = document.createElement('div');
      dot.className = 'dot' + (allDone ? ' done' : '');
      item.appendChild(dot);
    }

    item.onclick = () => { selectedDate = value; renderDateStrip(); render(); };
    dateStrip.appendChild(item);
  }
}

/* ===== Month calendar ===== */
function renderMonthCalendar() {
  calendarGrid.innerHTML = '';
  const y = calendarMonth.getFullYear();
  const m = calendarMonth.getMonth();
  calendarTitle.textContent = `${y}ë…„ ${m + 1}ì›”`;

  const first = new Date(y, m, 1).getDay();
  const last = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < first; i++) calendarGrid.appendChild(document.createElement('div'));

  for (let d = 1; d <= last; d++) {
    const cell = document.createElement('div');
    const dateObj = new Date(y, m, d);
    const dateStr = formatDate(dateObj);

    cell.className = 'calendar-cell';
    cell.textContent = d;

    if (dateStr === formatDate(new Date())) cell.classList.add('today');
    if (dateStr === selectedDate) cell.classList.add('selected');

    const dayTodos = todos.filter(t => t.date === dateStr);
    if (dayTodos.length) {
      const dot = document.createElement('div');
      dot.className = 'dot' + (dayTodos.every(t => t.completed) ? ' done' : '');
      cell.appendChild(dot);
    }

    cell.onclick = () => {
      selectedDate = dateStr;
      calendarOverlay.style.display = 'none';
      renderDateStrip();
      render();
    };

    calendarGrid.appendChild(cell);
  }
}

/* ===== ë Œë” ===== */
function render() {
  list.innerHTML = '';

  const visible = todos.filter(t => t.date === selectedDate);

  visible.forEach(t => {
    const li = document.createElement('li');
    if (t.completed) li.classList.add('completed');

    const task = document.createElement('div');
    task.className = 'task';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = t.completed;
    checkbox.onchange = () => {
      t.completed = checkbox.checked;
      saveTodos();
      render();
    };

    const span = document.createElement('span');
    span.textContent = t.text;

    task.append(checkbox, span);

    const star = document.createElement('button');
    star.className = 'star-btn';
    star.textContent = t.important ? 'â˜…' : 'â˜†';
    star.onclick = () => {
      t.important = !t.important;
      saveTodos();
      render();
    };

    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.textContent = 'âœ•';
    del.onclick = () => {
      todos = todos.filter(x => x !== t);
      saveTodos();
      render();
    };

    li.append(task, star, del);
    list.appendChild(li);
  });

  counter.textContent = `ë‚¨ì€ í•  ì¼: ${visible.filter(t => !t.completed).length}ê°œ`;
}

/* ===== ì´ë²¤íŠ¸ ===== */
document.getElementById('openCalendarBtn').onclick = () => {
  calendarMonth = new Date(selectedDate);
  calendarOverlay.style.display = 'flex';
  renderMonthCalendar();
};

calendarOverlay.addEventListener('click', e => {
  if (e.target === calendarOverlay) calendarOverlay.style.display = 'none';
});

document.getElementById('prevMonth').onclick = () => {
  calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() - 1, 1);
  renderMonthCalendar();
};

document.getElementById('nextMonth').onclick = () => {
  calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + 1, 1);
  renderMonthCalendar();
};

// add todo
document.getElementById('addBtn').onclick = () => {
  const text = input.value.trim();
  if (!text) return;

  todos.push({
    id: crypto.randomUUID(),
    text,
    completed: false,
    important: false,
    date: selectedDate,
    time: timeInput.value || null
  });

  input.value = '';
  timeInput.value = '';
  saveTodos();
  render();
};

// delete completed
document.getElementById('clearCompletedBtn').onclick = () => {
  todos = todos.filter(t => !(t.date === selectedDate && t.completed));
  saveTodos();
  render();
};

/* ===== ì´ˆê¸°í™” ===== */
loadTodos();
renderDateStrip();
render();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>

</body>
</html>
